#!/bin/bash

root_dir=`pwd`

# curl
export CURL=curl
export CURL_VERSION=7.32.0
export CURL_EXTRA="--disable-ftp --disable-file --disable-ldap --disable-ldaps --disable-rtsp --disable-dict --disable-telnet --disable-tftp --disable-pop3 --disable-imap --disable-smtp --disable-gopher --disable-sspi --without-librtmp --without-libidn --without-libssh2"
export CURL_SOURCE_FILE=$CURL-$CURL_VERSION.tar.gz
export CURL_SOURCE_FOLDER=$CURL-$CURL_VERSION
export CURL_CONFIGURED=$CURL/$CURL_SOURCE_FOLDER/curl-config
export CURL_DOWNLOAD_URL=http://curl.haxx.se/download/$CURL_SOURCE_FILE
export CURL_SOURCE_DIR=$root_dir/$CURL/$CURL_SOURCE_FOLDER
export CURL_INSTALL_DIR=$root_dir/MEGASync/mega/bindings/qt/3rdparty

export MAKE_OPTS="-j1"

echo "Checking if native cURL uses c-ares..."
#if curl-config --configure  2>&1 | grep enable-ares > /dev/null;
if curl-config --configure  2>&1 | grep enable-ares > /dev/null;
then
	echo "cURL uses c-ares. We will use it!"
	rm -rf $CURL
	curl_conf=""
else
	echo "cURL doesn't use c-ares. We will use our own build"
    if [ ! -f $CURL_SOURCE_FILE ]; then
        wget -c $CURL_DOWNLOAD_URL || exit 1
    fi

    rm -fr $CURL
	mkdir $CURL
	cd $CURL
	tar --overwrite -xf ../$CURL_SOURCE_FILE
	ln -sf $CURL_SOURCE_FOLDER $CURL
	cd $CURL_SOURCE_FOLDER || exit 1
	./configure --enable-ipv6 --disable-manual --enable-shared=no --enable-static --with-zlib --enable-ares --with-ssl $CURL_EXTRA || exit 1
	make $MAKE_OPTS || exit 1
	cd ../..
	mkdir -p $CURL_SOURCE_DIR/include/curl $CURL_INSTALL_DIR/include/
	ln -sf $CURL_SOURCE_DIR/include/curl $CURL_INSTALL_DIR/include/curl
	mkdir -p $CURL_INSTALL_DIR/lib/
	mkdir -p $CURL_INSTALL_DIR/libs/
	ln -sf $CURL_SOURCE_DIR/lib/.libs/libcurl.a $CURL_INSTALL_DIR/libs/libcurl.a
	ln -sf $CURL_SOURCE_DIR/lib/.libs/libcurl.a $CURL_INSTALL_DIR/lib/libcurl.a
	curl_conf="--with-curl=$CURL_INSTALL_DIR"
fi

# libsodium
export SODIUM=libsodium
export SODIUM_VERSION=0.5.0
export SODIUM_SOURCE_FILE=$SODIUM-$SODIUM_VERSION.tar.gz
export SODIUM_SOURCE_FOLDER=$SODIUM-$SODIUM_VERSION
export SODIUM_DOWNLOAD_URL=http://download.libsodium.org/libsodium/releases/$SODIUM_SOURCE_FILE
export SODIUM_SOURCE_DIR=$root_dir/$SODIUM/$SODIUM_SOURCE_FOLDER
export SODIUM_INSTALL_DIR=$root_dir/MEGASync/mega/bindings/qt/3rdparty

if [ ! -f $SODIUM_SOURCE_FILE ]; then
    wget -c $SODIUM_DOWNLOAD_URL || exit 1
fi

rm -fr $SODIUM
mkdir $SODIUM
cd $SODIUM
tar --overwrite -xf ../$SODIUM_SOURCE_FILE
ln -sf $SODIUM_SOURCE_FOLDER $SODIUM
cd $SODIUM_SOURCE_FOLDER || exit 1
./configure --disable-shared --enable-static || exit 1
make $MAKE_OPTS || exit 1
cd ../..
mkdir -p $SODIUM_INSTALL_DIR
mkdir $SODIUM_INSTALL_DIR/include/
cp -R $SODIUM_SOURCE_DIR/src/libsodium/include/* $SODIUM_INSTALL_DIR/include/
mkdir -p $SODIUM_INSTALL_DIR/lib/
mkdir -p $SODIUM_INSTALL_DIR/libs/
ln -sf $SODIUM_SOURCE_DIR/src/libsodium/.libs/libsodium.a $SODIUM_INSTALL_DIR/libs/
ln -sf $SODIUM_SOURCE_DIR/src/libsodium/.libs/libsodium.a $SODIUM_INSTALL_DIR/lib/
sodium_conf="--with-sodium=$SODIUM_INSTALL_DIR"

cd MEGASync/mega
./autogen.sh || exit 1
./configure --disable-curl-checks $curl_conf $sodium_conf --without-freeimage || exit 1
cd ../..
